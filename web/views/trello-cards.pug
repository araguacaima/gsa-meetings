extends layout

block title
    title= title
block scripts
    script(type='text/javascript', src='/javascripts/jquery-3.2.1.js')
    script(type='text/javascript', src='/javascripts/jquery-outside-events-plugin.js')
    script(type='text/javascript', src='/javascripts/jquery.ddslick.js')
    script(type='text/javascript', src='/javascripts/jquery-ui.js')
    link(rel='stylesheet', type='text/css', href='/bower_components/bootstrap/dist/css/bootstrap.min.css')
    link(rel='stylesheet', type='text/css', href='/stylesheets/jquery-ui.css')
    link(rel='stylesheet', type='text/css', href='/stylesheets/autocomplete.css')
    script.
        var cardsStr = '!{JSON.stringify(cards)}'.replace(/\n/g, "<br>");
        var cardsArray = JSON.parse(cardsStr);
        var jiraMeta = JSON.parse('!{JSON.stringify(jiraMeta)}');
        var issueTypesCombo = JSON.parse('!{JSON.stringify(issueTypesCombo)}');
        var priorityCombo = JSON.parse('!{JSON.stringify(priorityCombo)}');
        var whoShowsTrelloInfo = undefined;

        Array.prototype.pushAll = function (arguments) {
            for (let i = 0; i < arguments.length; i++) {
                this.push(arguments[i]);
            }
        }

        function isChildOf(element, parentId) {
            return (element.parents("#" + parentId).length);
        }

        $(function () {

            $("#parent").autocomplete({
                minLength: 3,
                source: function (request, response) {
                    $.get("/jira/tickets", {q: request.term})
                        .done(function (data) {
                            let issues = [{id: "-1", value: "Select one..."}];
                            issues.pushAll(data.map(function (issue) {
                                return {id: issue.key, value: issue.key + " - " + issue.summary};
                            }));
                            response(issues);
                        });
                },
                select: function (event, ui) {

                },
                // optional (if other layers overlap autocomplete list)
                open: function (event, ui) {
                    $(".ui-autocomplete").css("z-index", 1000);
                }
            }).on("click", function () {
                $(this).select();
            });
            ;

            $("#issueTypesSelect").ddslick({
                data: issueTypesCombo,
                width: 200,
                selectText: "Issue type...",
                imagePosition: "left",
                onSelected: function (selectedData) {
                    //callback function: do something with selectedData;
                }
            });

            $("#prioritySelect").ddslick({
                data: priorityCombo,
                width: 200,
                selectText: "Priority...",
                imagePosition: "left",
                onSelected: function (selectedData) {
                    //callback function: do something with selectedData;
                }
            });

            var cards = $("*[id$='_text']")
            cards.click(function (e) {
                var cards = $("*[id$='_text']")
                cards.each(function (index, element) {
                    var $element = $(element);
                    $element.css("background-color", "#FFFFFF");
                    $element.css("font-weight", "");
                    var parent = $element.parents("section.css-table")[0];
                    $(parent).css("background-color", "#FFFFFF");
                });
                const currentTarget = $(e.currentTarget);
                currentTarget.css("background-color", "#F7F7F7");
                currentTarget.bind('clickoutside', function (e) {
                    var target = $(e.target);
                    var clicked = $(e.currentTarget);
                    var id = target.attr("id");
                    if (id !== undefined && (whoShowsTrelloInfo !== id
                            && !id.endsWith("_text")
                            && id !== "info"
                            && !isChildOf(target, "info")
                            && id !== "meta"
                            && !isChildOf(target, "meta"))) {
                        $("#info").hide();
                        $("#meta").hide();
                        $(target).css("background-color", "#FFFFFF");
                        $(target).css("font-weight", "");
                        whoShowsTrelloInfo = undefined;
                    }
                });
                const id = currentTarget.attr("id").replace("_text", "");
                var cardInfo = $.grep(cardsArray, function (e) {
                    return e.id === id;
                });
                var info = cardInfo[0];
                var comments = [];
                let creationDate;
                info.actions.forEach(function (action) {
                    if (action.type === "commentCard") {
                        comments.push(" * *" + action.memberCreator.username + " | {color:#707070}_" + action.date.split("T")[0] + "_{color}:* " + action.data.text);
                    } else if (action.type === "createCard") {
                        var updateDate = new Date(action.date);
                        if (creationDate === undefined) {
                            creationDate = updateDate;
                        } else {
                            if (updateDate < creationDate) {
                                creationDate = updateDate;
                            }
                        }
                    }
                });
                $("#_info_description").html(
                    (info.desc !== undefined ? "h2. <strong>Descripci√≥n:</strong><br>" +
                        "<br>" +
                        info.desc + "<br><br>" : "") +
                    (comments.length > 0 ? "h2. <strong>Comentarios:</strong><br>" +
                        "<br>" +
                        comments.join("<br>") + "<br><br>" : "") +
                    (info.due !== undefined ? "h2. <strong>Fecha de compromiso:</strong><br>" +
                        "<br>" +
                        info.due.split("T")[0] + "<br><br>" : "") +
                    "h2. <strong>Migrado desde:</strong><br>" +
                    "<br>" +
                    info.shortUrl + "<br>");
                var labels = info.labels;
                var labels_ = [];
                labels.forEach(function (element) {
                    labels_.push(element.name.replace(/[ /|]/g, "-"));
                });
                $("#_info_labels").text(labels_.join());
                whoShowsTrelloInfo = id;
                $("#info").show();
                $("#meta").show();
                var parent = currentTarget.parents("section.css-table")[0];
                $(parent).css("background-color", "#F7F7F7");
                $(parent).css("width", "100%");
                currentTarget.css("font-weight", "bold");
            });
        });
block content
    h1 Pick up your trello cards.
    br
    form(action='/jira/tickets', method='post')
        .container
            section.css-table
                section.three-column
                    section.cell
                        each card in cards
                            section.css-table(style="width=100%;")
                                if processSeveral
                                    section.two-column
                                unless processSeveral
                                    section
                                    if processSeveral
                                        section.cell(style="display: inline-block;")
                                            .text
                                                input(type='checkbox', name='cards', id= card.id, value= card.name)
                                        section.cell
                                            div(style="width=90%;")
                                                h3(style="margin-bottom: 0; margin-top: 0; margin-left: 10px")= card.name
                                    unless processSeveral
                                        section.cell(style="display: block;")
                                            div(style="width=90%;")
                                                h3(style="margin-bottom: 0; margin-top: 0; margin-left: 10px", id= card.id + "_text")= card.name
                    section#info.cell(style="display: none; background-color: #F7F7F7;")
                        section.css-table
                            section.two-column
                                section.cell(style="vertical-align: middle;")
                                    .text
                                        h4#_info_description_label Description:
                                section.cell(style="vertical-align: middle;")
                                    .text
                                        div#_info_description
                            section.two-column
                                section.cell(style="vertical-align: middle;")
                                    .text
                                        h4#_info_labels_label Labels:
                                section.cell(style="vertical-align: middle;")
                                    .text
                                        div#_info_labels
                    section#meta.cell
                        div#_meta
                            div#issueTypesSelect
                            div#prioritySelect
                            label(for="parent") Parent:&nbsp;
                            div.ui-widget
                                input#parent
                            unless processSeveral
                                .text-center(style="margin: 30px;")
                            button.btn.btn-danger.btn-lg(type='submit')
                                span.icon-size-small.icon-jira-alt
                                | &nbsp;Push to Jira

            if processSeveral
                .text-center(style="margin: 30px;")
                    button.btn.btn-danger.btn-lg(type='submit')
                        span.icon-size-small.icon-jira-alt
                        | &nbsp;Push to Jira